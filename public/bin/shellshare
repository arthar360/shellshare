#!/usr/bin/env python
import tempfile
import string
import random
import thread
import time
import base64
import sys
import httplib2
import urllib
import os
import platform


def id_generator(size=9, chars=string.ascii_letters + string.digits):
    return ''.join(random.choice(chars) for x in range(size))


def post(url, data):
    headers = {'Content-type': 'application/x-www-form-urlencoded'}
    postData = dict(message=data)
    httplib2.Http().request(url, 'POST', headers=headers, body=urllib.urlencode(postData))


def stream_file(path, url):
    f = open(path, 'rb')
    while True:
        time.sleep(1)
        data = ''
        while True:
            new = f.readline()
            if not new:
                break
            data += new
        if not (data == ''):
            encoded_str = base64.b64encode(data)
            post(url, encoded_str)


tmp = tempfile.NamedTemporaryFile()
channel = sys.argv[1] if len(sys.argv) > 1 else id_generator()
url = 'http://www.shellshare.net/%s' % channel

if platform.system() == 'Darwin':
    shell_args = '-qt 0'
else:
    shell_args = '-qf'

print tmp.name

print 'Sharing session in %s...' % url
thread.start_new_thread(stream_file, (tmp.name, url))
os.system('script %s %s' % (shell_args, tmp.name))
print 'End of transmission.'
